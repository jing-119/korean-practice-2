<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>韓語單字＋文法練習工具</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tab-btn{ @apply px-3 py-2 rounded-2xl text-sm font-medium hover:bg-slate-100; }
    .tab-btn.active{ @apply bg-slate-900 text-white; }
    .btn{ @apply px-3 py-2 rounded-2xl bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm; }
    .btn-primary{ @apply bg-indigo-600 hover:bg-indigo-700 text-white; }
    .btn-danger{ @apply bg-rose-600 hover:bg-rose-700 text-white; }
    .chip{ @apply inline-block px-2 rounded-full bg-slate-100 text-slate-600; }
    .input{ @apply border rounded-xl px-3 py-2 text-sm border-slate-300; }
    .label{ @apply text-xs text-slate-500; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-6xl mx-auto p-4">
    <header class="flex items-center justify-between mb-4">
      <h1 class="text-xl font-bold">韓語單字＋文法練習工具</h1>
      <nav class="flex gap-2">
        <button data-tab="review" class="tab-btn active">閱讀卡/複習</button>
        <button data-tab="quiz" class="tab-btn">測驗</button>
        <button data-tab="grammar" class="tab-btn">文法</button>
        <button data-tab="vocab" class="tab-btn">單字庫</button>
        <button data-tab="settings" class="tab-btn">設定/匯入匯出</button>
      </nav>
    </header>

    <!-- REVIEW TAB -->
    <section id="tab-review" class="tab">
      <div id="review-empty" class="hidden p-6 text-center text-slate-500">今天沒有到期的卡片～ 去單字庫新增一些吧！</div>
      <div id="review-card" class="hidden bg-white rounded-2xl shadow p-6">
        <div class="flex items-center justify-between mb-2">
          <div class="text-xs text-slate-500">Leitner 盒位：<span id="rc-box"></span></div>
          <div class="text-xs text-slate-500">到期：<span id="rc-due"></span></div>
        </div>
        <div class="text-2xl font-semibold mb-2" id="rc-ko">학교</div>
        <div class="text-slate-600 mb-2" id="rc-meaning">學校</div>
        <div class="text-slate-500 text-sm" id="rc-example">저는 학교에 갑니다.</div>
        <div class="mt-4 flex gap-2">
          <button id="rc-show" class="btn">顯示/隱藏答案</button>
          <button id="rc-correct" class="btn-primary">答對（升盒）</button>
          <button id="rc-wrong" class="btn-danger">答錯（回盒1）</button>
          <button id="rc-skip" class="btn">略過</button>
        </div>
      </div>
      <div class="mt-3 text-sm text-slate-500">待複習：<span id="rc-remaining">0</span> 張</div>
    </section>

    <!-- QUIZ TAB -->
    <section id="tab-quiz" class="tab hidden">
      <div class="mb-3 flex gap-2">
        <select id="quiz-type" class="input">
          <option value="mc">選擇題（看韓文 → 選中文）</option>
          <option value="spell">拼寫題（看中文 → 打韓文）</option>
        </select>
        <button id="quiz-start" class="btn-primary">開始測驗</button>
      </div>
      <div id="quiz-area" class="hidden bg-white rounded-2xl shadow p-6">
        <div class="text-sm text-slate-500">第 <span id="q-idx">1</span> 題 / <span id="q-total">10</span></div>
        <div id="q-stem" class="text-2xl font-semibold my-3">학교</div>
        <div id="q-mc" class="grid grid-cols-1 sm:grid-cols-2 gap-2"></div>
        <div id="q-spell" class="hidden">
          <input id="q-input" class="input w-full mb-2" placeholder="請輸入韓文拼寫..." />
          <button id="q-submit" class="btn-primary">送出</button>
        </div>
        <div id="q-feedback" class="mt-3 text-sm"></div>
      </div>
      <div id="quiz-result" class="hidden p-6 text-center bg-white rounded-2xl shadow">
        <div class="text-lg font-semibold">完成！</div>
        <div class="text-slate-600">正確 <span id="qr-correct">0</span> / <span id="qr-total">0</span></div>
      </div>
    </section>

    <!-- GRAMMAR TAB -->
    <section id="tab-grammar" class="tab hidden">
      <div class="mb-2 flex items-center justify-between">
        <div class="text-sm text-slate-600">自訂文法題庫</div>
        <button id="gm-add" class="btn-primary">新增題目</button>
      </div>
      <div id="gm-list" class="space-y-2"></div>
      <hr class="my-4" />
      <div class="flex gap-2 items-center">
        <button id="gm-start" class="btn">開始文法測驗</button>
        <span class="text-xs text-slate-500">（單選題，* 代表正確答案）</span>
      </div>
      <div id="gm-quiz" class="hidden bg-white rounded-2xl shadow p-6 mt-3"></div>
    </section>

    <!-- VOCAB TAB -->
    <section id="tab-vocab" class="tab hidden">
      <div class="flex flex-wrap gap-2 items-end mb-3">
        <div>
          <div class="label">搜尋</div>
          <input id="v-search" class="input" placeholder="輸入韓文/中文/例句" />
        </div>
        <div>
          <div class="label">排序</div>
          <select id="v-sort" class="input">
            <option value="createdDesc">新增時間（新→舊）</option>
            <option value="createdAsc">新增時間（舊→新）</option>
            <option value="koAsc">韓文 A→Z</option>
            <option value="koDesc">韓文 Z→A</option>
          </select>
        </div>
        <div class="ml-auto flex gap-2">
          <button id="btn-add-vocab" class="btn btn-primary">新增單字</button>
          <button id="btn-batch-add" class="btn">批量新增</button>
        </div>
      </div>
      <div id="v-list" class="grid gap-2"></div>
    </section>

    <!-- SETTINGS TAB -->
    <section id="tab-settings" class="tab hidden">
      <div class="grid sm:grid-cols-2 gap-4">
        <div class="bg-white rounded-2xl shadow p-4">
          <div class="font-semibold mb-2">Leitner 間隔（天）</div>
          <div class="flex gap-2 mb-2">
            <input id="stg-box1" class="input w-20" type="number" min="1" />
            <input id="stg-box2" class="input w-20" type="number" min="1" />
            <input id="stg-box3" class="input w-20" type="number" min="1" />
            <input id="stg-box4" class="input w-20" type="number" min="1" />
            <input id="stg-box5" class="input w-20" type="number" min="1" />
          </div>
          <button id="stg-save" class="btn-primary">儲存設定</button>
        </div>
        <div class="bg-white rounded-2xl shadow p-4">
          <div class="font-semibold mb-2">匯入 / 匯出（JSON 備份）</div>
          <div class="flex gap-2 mb-2">
            <button id="expt" class="btn">匯出 JSON</button>
            <input id="impt-file" type="file" accept="application/json" class="hidden" />
            <button id="impt" class="btn">匯入 JSON</button>
          </div>
          <button id="reset" class="btn btn-danger">清空（恢復內建範例）</button>
        </div>
      </div>
      <p class="mt-3 text-xs text-slate-500">所有資料都保存在你的瀏覽器 <code>localStorage</code>。更換電腦前請先匯出備份。</p>
    </section>
  </div>

  <script>
    // ===== 基礎工具 =====
    const uid = () => Math.random().toString(36).slice(2)+Date.now().toString(36);
    const todayStr = (d=new Date()) => d.toISOString().slice(0,10);
    const addDays = (d,days)=>{ const x=new Date(d); x.setDate(x.getDate()+days); return x; };

    const DEFAULT_DB = {
      settings: { leitner: [1,2,4,7,15] },
      vocab: [
        { id: uid(), ko: '학교', meaning: '學校', examples: '저는 학교에 갑니다.', box:1, nextDue: todayStr(), createdAt: Date.now() },
        { id: uid(), ko: '사랑', meaning: '愛', examples: '사랑해요.', box:1, nextDue: todayStr(), createdAt: Date.now() },
        { id: uid(), ko: '책', meaning: '書', examples: '책을 읽습니다.', box:1, nextDue: todayStr(), createdAt: Date.now() }
      ],
      grammar: [
        { id: uid(), stem: '「~고 있다」的用法是？', choices: ['進行/持續狀態*','過去完成','未來推測','被動語態'], explain: '表示動作正在進行或狀態持續。' },
        { id: uid(), stem: '接尾詞「~아요/어요」主要用於？', choices: ['敬語基本體*','命令式','過去式','假設語氣'], explain: '' }
      ]
    };

    let DB = loadData();

    function loadData(){
      try{ return JSON.parse(localStorage.getItem('koTrainer')||'') || structuredClone(DEFAULT_DB); }
      catch(e){ return structuredClone(DEFAULT_DB); }
    }
    function saveData(db){ localStorage.setItem('koTrainer', JSON.stringify(db)); }

    // ===== 分頁切換 =====
    const tabs = document.querySelectorAll('.tab-btn');
    tabs.forEach(btn=>btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(s=>s.classList.add('hidden'));
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      document.getElementById('tab-'+btn.dataset.tab).classList.remove('hidden');
      btn.classList.add('active');
      if(btn.dataset.tab==='review') refreshReview();
      if(btn.dataset.tab==='vocab') renderVocab();
      if(btn.dataset.tab==='grammar') renderGrammar();
      if(btn.dataset.tab==='settings') renderSettings();
    }));

    // ===== 複習（Leitner） =====
    let dueList = [];
    function refreshReview(){
      const today = todayStr();
      dueList = DB.vocab.filter(v => (v.nextDue || today) <= today);
      document.getElementById('rc-remaining').textContent = dueList.length;
      if(dueList.length===0){
        document.getElementById('review-empty').classList.remove('hidden');
        document.getElementById('review-card').classList.add('hidden');
        return;
      }
      document.getElementById('review-empty').classList.add('hidden');
      document.getElementById('review-card').classList.remove('hidden');
      showReviewCard(dueList[0]);
    }
    function showReviewCard(v){
      document.getElementById('rc-ko').textContent = v.ko;
      document.getElementById('rc-meaning').textContent = v.meaning;
      document.getElementById('rc-example').textContent = v.examples||'';
      document.getElementById('rc-box').textContent = v.box||1;
      document.getElementById('rc-due').textContent = v.nextDue||todayStr();
      document.getElementById('rc-meaning').classList.add('blur-sm');
      document.getElementById('rc-example').classList.add('blur-sm');
    }
    document.getElementById('rc-show').onclick=()=>{
      document.getElementById('rc-meaning').classList.toggle('blur-sm');
      document.getElementById('rc-example').classList.toggle('blur-sm');
    };
    function promote(v,right){
      const iv=DB.settings.leitner; // [1..5]
      if(right){ v.box = Math.min(5,(v.box||1)+1); }
      else { v.box = 1; }
      const days = iv[(v.box||1)-1] || 1;
      v.nextDue = todayStr(addDays(new Date(), days));
      saveData(DB);
      refreshReview();
    }
    document.getElementById('rc-correct').onclick=()=>{ if(dueList[0]) promote(dueList[0],true); };
    document.getElementById('rc-wrong').onclick=()=>{ if(dueList[0]) promote(dueList[0],false); };
    document.getElementById('rc-skip').onclick=()=>{ if(dueList.length>1){ const x=dueList.shift(); dueList.push(x); showReviewCard(dueList[0]); } };

    // ===== 測驗 =====
    let quizPool=[], qi=0, qc=0;
    document.getElementById('quiz-start').onclick=()=>{
      const type = document.getElementById('quiz-type').value;
      quizPool = shuffle(DB.vocab.slice()).slice(0, Math.min(10, DB.vocab.length));
      qi=0; qc=0;
      document.getElementById('quiz-result').classList.add('hidden');
      document.getElementById('quiz-area').classList.remove('hidden');
      document.getElementById('q-total').textContent = quizPool.length;
      if(type==='mc') showMC(); else showSpell();
    };
    function showMC(){
      const v = quizPool[qi]; if(!v){ return finishQuiz(); }
      document.getElementById('q-idx').textContent = qi+1;
      document.getElementById('q-stem').textContent = v.ko;
      document.getElementById('q-mc').innerHTML='';
      document.getElementById('q-spell').classList.add('hidden');
      document.getElementById('q-mc').classList.remove('hidden');
      const opts = shuffle([v, ...shuffle(DB.vocab.filter(x=>x.id!==v.id)).slice(0,3)]).map(o=>o.meaning);
      opts.forEach(m=>{
        const b=document.createElement('button'); b.className='btn w-full text-left'; b.textContent=m;
        b.onclick=()=>{ if(m===v.meaning){ qc++; fb('✅ 正確'); } else { fb(`❌ 錯誤，答案：${v.meaning}`); }
          nextQ(); };
        document.getElementById('q-mc').appendChild(b);
      });
      document.getElementById('q-feedback').textContent='';
    }
    function showSpell(){
      const v = quizPool[qi]; if(!v){ return finishQuiz(); }
      document.getElementById('q-idx').textContent = qi+1;
      document.getElementById('q-stem').textContent = v.meaning;
      document.getElementById('q-mc').classList.add('hidden');
      document.getElementById('q-spell').classList.remove('hidden');
      const input=document.getElementById('q-input'); input.value=''; input.focus();
      document.getElementById('q-feedback').textContent='';
      document.getElementById('q-submit').onclick=()=>{
        if(input.value.trim()===v.ko){ qc++; fb('✅ 正確'); } else { fb(`❌ 錯誤，答案：${v.ko}`); }
        nextQ();
      };
    }
    function nextQ(){ qi++; const type=document.getElementById('quiz-type').value; if(qi>=quizPool.length) return finishQuiz(); if(type==='mc') showMC(); else showSpell(); }
    function finishQuiz(){
      document.getElementById('quiz-area').classList.add('hidden');
      document.getElementById('quiz-result').classList.remove('hidden');
      document.getElementById('qr-correct').textContent = qc;
      document.getElementById('qr-total').textContent = quizPool.length;
    }
    function fb(text){ document.getElementById('q-feedback').textContent = text; }
    function shuffle(a){ return a.map(x=>[Math.random(),x]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]); }

    // ===== 文法 =====
    function renderGrammar(){
      const wrap=document.getElementById('gm-list');
      wrap.innerHTML='';
      DB.grammar.forEach(g=>{
        const d=document.createElement('div'); d.className='bg-white rounded-2xl shadow p-4';
        d.innerHTML = `<div class="font-medium">${esc(g.stem)}</div>
          <div class="text-sm text-slate-600">${g.choices.map(c=>`<span class='chip mr-1'>${esc(c)}</span>`).join('')}</div>
          <div class="text-xs text-slate-500 mt-1">${esc(g.explain||'')}</div>
          <div class="mt-2 flex gap-2">
            <button class="btn" data-edit="${g.id}">編輯</button>
            <button class="btn btn-danger" data-del="${g.id}">刪除</button>
          </div>`;
        wrap.appendChild(d);
      });
      wrap.querySelectorAll('[data-edit]').forEach(b=> b.onclick=()=> editGrammar(b.dataset.edit));
      wrap.querySelectorAll('[data-del]').forEach(b=> b.onclick=()=> delGrammar(b.dataset.del));
    }
    function editGrammar(id){
      const g = DB.grammar.find(x=>x.id===id) || { id: uid(), stem:'', choices:['正確*','錯誤'], explain:'' };
      const isNew = !DB.grammar.find(x=>x.id===id);
      const wrapper=document.createElement('div'); wrapper.className='fixed inset-0 bg-black/30 flex items-center justify-center p-4 z-50';
      wrapper.innerHTML = `<div class='bg-white rounded-2xl shadow-xl w-full max-w-2xl p-6'>
        <h3 class='font-semibold mb-3'>${isNew?'新增題目':'編輯題目'}</h3>
        <label class='label'>題目</label>
        <textarea id='g-stem' class='input w-full h-24'>${esc(g.stem)}</textarea>
        <label class='label mt-2'>選項（每行一個，正確答案以 * 結尾）</label>
        <textarea id='g-choices' class='input w-full h-28'>${esc(g.choices.join('\n'))}</textarea>
        <label class='label mt-2'>解說（可省略）</label>
        <textarea id='g-explain' class='input w-full h-20'>${esc(g.explain||'')}</textarea>
        <div class='flex justify-end gap-2 mt-4'>
          <button class='btn' id='g-cancel'>取消</button>
          <button class='btn btn-primary' id='g-save'>儲存</button>
        </div></div>`;
      document.body.appendChild(wrapper);
      wrapper.querySelector('#g-cancel').onclick=()=> wrapper.remove();
      wrapper.querySelector('#g-save').onclick=()=>{
        const stem = wrapper.querySelector('#g-stem').value.trim();
        const choices = wrapper.querySelector('#g-choices').value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        const explain = wrapper.querySelector('#g-explain').value.trim();
        const obj = { id:g.id, stem, choices, explain };
        if(isNew) DB.grammar.push(obj); else Object.assign(g,obj);
        saveData(DB); wrapper.remove(); renderGrammar();
      };
    }
    function delGrammar(id){ if(confirm('確定刪除這題？')){ DB.grammar = DB.grammar.filter(x=>x.id!==id); saveData(DB); renderGrammar(); } }

    // 文法測驗（單選）
    document.getElementById('gm-add').onclick=()=> editGrammar();
    document.getElementById('gm-start').onclick=()=> startGrammarQuiz();
    function startGrammarQuiz(){
      if(DB.grammar.length===0){ alert('尚無題目，先新增吧！'); return; }
      const pool=shuffle(DB.grammar.slice()); let i=0, correct=0;
      const box=document.getElementById('gm-quiz'); box.classList.remove('hidden');
      ask();
      function ask(){
        const g=pool[i];
        box.innerHTML='';
        const stem=document.createElement('div'); stem.className='text-lg font-semibold mb-2'; stem.textContent=g.stem; box.appendChild(stem);
        const ul=document.createElement('div'); ul.className='grid gap-2';
        const right = g.choices.find(c=>/\*$/.test(c))?.replace(/\*$/,'');
        g.choices.map(c=>c.replace(/\*$/,'')).forEach(opt=>{
          const b=document.createElement('button'); b.className='btn text-left'; b.textContent=opt; b.onclick=()=>{
            if(opt===right){ correct++; alert('✅ 正確'); } else { alert(`❌ 正確答案：${right}`); }
            i++; if(i>=pool.length){ box.innerHTML=`<div>完成！正確 ${correct} / ${pool.length}</div>`; } else ask();
          }; ul.appendChild(b);
        }); box.appendChild(ul);
        if(g.explain){ const ex=document.createElement('div'); ex.className='text-xs text-slate-500 mt-2'; ex.textContent=g.explain; box.appendChild(ex); }
      }
    }

    // ===== 單字庫 =====
    const vSearch = document.getElementById('v-search');
    const vSort = document.getElementById('v-sort');
    document.getElementById('btn-add-vocab').onclick=()=> editVocab();
    document.getElementById('btn-batch-add').onclick=()=> batchAddModal();

    function renderVocab(){
      const q=(vSearch.value||'').toLowerCase();
      const arr=DB.vocab.filter(v=> !q || [v.ko,v.meaning,v.examples].join(' ').toLowerCase().includes(q));
      const sorted=arr.sort((a,b)=>{
        const k=vSort.value;
        if(k==='createdDesc') return (b.createdAt||0)-(a.createdAt||0);
        if(k==='createdAsc') return (a.createdAt||0)-(b.createdAt||0);
        if(k==='koAsc') return a.ko.localeCompare(b.ko);
        if(k==='koDesc') return b.ko.localeCompare(a.ko);
        return 0;
      });
      const wrap=document.getElementById('v-list');
      wrap.innerHTML='';
      sorted.forEach(v=>{
        const d=document.createElement('div'); d.className='bg-white rounded-2xl shadow p-4';
        d.innerHTML = `<div class='flex justify-between'>
          <div class='text-lg font-semibold'>${esc(v.ko)}</div>
          <div class='text-xs text-slate-500'>盒位 ${v.box||1}｜下次 ${esc(v.nextDue||todayStr())}</div>
        </div>
        <div class='text-slate-600'>${esc(v.meaning)}</div>
        <div class='text-slate-500 text-sm'>${esc(v.examples||'')}</div>
        <div class='mt-2 flex gap-2'>
          <button class='btn' data-edit='${v.id}'>編輯</button>
          <button class='btn btn-danger' data-del='${v.id}'>刪除</button>
        </div>`;
        wrap.appendChild(d);
      });
      wrap.querySelectorAll('[data-edit]').forEach(b=> b.onclick=()=> editVocab(b.dataset.edit));
      wrap.querySelectorAll('[data-del]').forEach(b=> b.onclick=()=> delVocab(b.dataset.del));
    }

    function editVocab(id){
      const v = DB.vocab.find(x=>x.id===id) || { id: uid(), ko:'', meaning:'', examples:'', box:1, nextDue: todayStr(), createdAt: Date.now() };
      const isNew = !DB.vocab.find(x=>x.id===id);
      const wrapper=document.createElement('div'); wrapper.className='fixed inset-0 bg-black/30 flex items-center justify-center p-4 z-50';
      wrapper.innerHTML = `<div class='bg-white rounded-2xl shadow-xl w-full max-w-2xl p-6'>
        <h3 class='font-semibold mb-3'>${isNew?'新增單字':'編輯單字'}</h3>
        <label class='label'>韓文</label>
        <input id='v-ko' class='input w-full' value='${esc(v.ko)}' />
        <label class='label mt-2'>中文意思</label>
        <input id='v-meaning' class='input w-full' value='${esc(v.meaning)}' />
        <label class='label mt-2'>例句（可省略）</label>
        <textarea id='v-ex' class='input w-full h-24'>${esc(v.examples||'')}</textarea>
        <div class='flex justify-end gap-2 mt-4'>
          <button class='btn' id='v-cancel'>取消</button>
          <button class='btn btn-primary' id='v-save'>儲存</button>
        </div></div>`;
      document.body.appendChild(wrapper);
      wrapper.querySelector('#v-cancel').onclick=()=> wrapper.remove();
      wrapper.querySelector('#v-save').onclick=()=>{
        const ko=wrapper.querySelector('#v-ko').value.trim();
        const meaning=wrapper.querySelector('#v-meaning').value.trim();
        const examples=wrapper.querySelector('#v-ex').value.trim();
        if(!ko||!meaning){ alert('請填寫韓文與中文意思'); return; }
        const payload={ id:v.id, ko, meaning, examples, box:v.box||1, nextDue:v.nextDue||todayStr(), createdAt: v.createdAt||Date.now() };
        if(isNew) DB.vocab.push(payload); else Object.assign(v,payload);
        saveData(DB); wrapper.remove(); renderVocab(); refreshReview();
      };
    }
    function delVocab(id){ if(confirm('確定刪除這個單字？')){ DB.vocab = DB.vocab.filter(x=>x.id!==id); saveData(DB); renderVocab(); refreshReview(); } }

    // 批量新增單字：支援 |（pipe）、Tab、或空白（三段式）
    function batchAddModal(){
      const wrapper=document.createElement('div'); wrapper.className='fixed inset-0 bg-black/30 flex items-center justify-center p-4 z-50';
      wrapper.innerHTML = `<div class='bg-white rounded-2xl shadow-xl w-full max-w-3xl p-6'>
        <h3 class='font-semibold mb-3'>批量新增單字</h3>
        <p class='text-sm text-slate-600 mb-3'>每行一筆，支援三種分隔：<br>
        1) <span class='chip'>韓文 意思 例句…</span>（空白分隔，例句可省略）<br>
        2) <span class='chip'>韓文 | 意思 | 例句 | 讀音 | 詞性 | 標籤</span><br>
        3) <span class='chip'>韓文\t意思\t例句</span>（Tab）</p>
        <textarea id='batch-text' class='input w-full h-56 font-mono' placeholder='例如：\n학교 學校 저는 학교에 갑니다.\n사랑 愛 사랑해요.\n책 本 책을 읽습니다.\n또|再、又|또 만나요.|tto|부사|頻率'></textarea>
        <div class='flex justify-end gap-2 mt-4'>
          <button class='btn' id='batch-cancel'>取消</button>
          <button class='btn btn-primary' id='batch-commit'>加入</button>
        </div></div>`;
      document.body.appendChild(wrapper);
      wrapper.querySelector('#batch-cancel').onclick=()=> wrapper.remove();
      wrapper.querySelector('#batch-commit').onclick=()=>{
        const text = wrapper.querySelector('#batch-text').value.trim();
        if(!text){ alert('請先貼上內容'); return; }
        const items = parseBatch(text);
        if(items.length===0){ alert('沒有可匯入的資料，請檢查格式'); return; }
        items.forEach(v=>{ v.id=uid(); v.box=1; v.nextDue=todayStr(); v.createdAt=Date.now(); DB.vocab.push(v); });
        saveData(DB); wrapper.remove(); renderVocab(); refreshReview();
        alert(`已加入 ${items.length} 筆單字`);
      };
    }
    function parseBatch(text){
      const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const out=[];
      for(const line of lines){
        let parts = line.split('|').map(s=>s.trim());
        if(parts.length>=2){
          const [ko, meaning, examples='', reading='', pos='', tags=''] = parts;
          if(ko&&meaning) out.push({ ko, meaning, examples, reading, pos, tags });
          continue;
        }
        parts = line.split('\t').map(s=>s.trim());
        if(parts.length>=2){
          const [ko, meaning, examples='', reading='', pos='', tags=''] = parts;
          if(ko&&meaning) out.push({ ko, meaning, examples, reading, pos, tags });
          continue;
        }
        const ws = line.split(/\s+/);
        if(ws.length>=2){ const [ko, meaning, ...rest] = ws; out.push({ ko, meaning, examples: rest.join(' ') }); }
      }
      return out;
    }

    vSearch.addEventListener('input', renderVocab);
    vSort.addEventListener('change', renderVocab);

    // ===== 設定 / 匯入匯出 =====
    function renderSettings(){
      const iv=DB.settings.leitner; // [1..5]
      document.getElementById('stg-box1').value = iv[0]||1;
      document.getElementById('stg-box2').value = iv[1]||2;
      document.getElementById('stg-box3').value = iv[2]||4;
      document.getElementById('stg-box4').value = iv[3]||7;
      document.getElementById('stg-box5').value = iv[4]||15;
    }
    document.getElementById('stg-save').onclick=()=>{
      const a=[1,2,4,7,15];
      a[0]=+document.getElementById('stg-box1').value||1;
      a[1]=+document.getElementById('stg-box2').value||2;
      a[2]=+document.getElementById('stg-box3').value||4;
      a[3]=+document.getElementById('stg-box4').value||7;
      a[4]=+document.getElementById('stg-box5').value||15;
      DB.settings.leitner=a; saveData(DB); alert('已儲存');
    };

    document.getElementById('expt').onclick=()=>{
      const blob = new Blob([JSON.stringify(DB,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='korean-backup.json'; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 500);
    };
    document.getElementById('impt').onclick=()=> document.getElementById('impt-file').click();
    document.getElementById('impt-file').addEventListener('change', (e)=>{
      const f=e.target.files?.[0]; if(!f) return;
      const reader=new FileReader(); reader.onload=()=>{
        try{ const data=JSON.parse(reader.result); if(!data.vocab||!data.settings) throw 0; DB=data; saveData(DB); alert('匯入完成'); location.reload(); }
        catch(_){ alert('匯入失敗：JSON 格式不正確'); }
      }; reader.readAsText(f);
    });
    document.getElementById('reset').onclick=()=>{ if(confirm('清空並恢復內建範例？')){ DB=structuredClone(DEFAULT_DB); saveData(DB); location.reload(); } };

    // ===== 初始渲染 =====
    function esc(s){ return (s||'').toString().replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
    renderVocab(); refreshReview();
  </script>
</body>
</html>
